{% extends "base.html" %}

{% block title %}İcarədar Paneli{% endblock %}

{% block head %}
<!-- Add Gauge.js library -->
<script src="https://bernii.github.io/gauge.js/dist/gauge.min.js"></script>
<!-- Add Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<script>
    // Define currentUserId at the top of the template
    const currentUserId = "{{ current_user.id }}";
</script>

<div class="container mt-4">
    <h1>Xoş gəlmisiniz, {{ current_user.name }}</h1>
    <div class="row">
        <div class="col-md-6">
            <div id="tenant-score">
                <!-- Tenant score will be loaded here -->
            </div>
        </div>
        <div class="col-md-6">
            <div id="credit-score">
                <!-- Credit score will be loaded here -->
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#properties" role="tab">Mövcud Əmlaklar</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#applications" role="tab">Müraciətlərim</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#scores" role="tab">Skorlarınız</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#received-ratings" role="tab">Aldığınız Qiymətləndirmələr</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#given-ratings" role="tab">Verdiyiniz Qiymətləndirmələr</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#rate-landlord" role="tab">İcarəyə verəni qiymətləndir</a>
            </li>
        </ul>
    </div>

    <div class="card-body">
        <div class="tab-content">
            <!-- Properties Tab -->
            <div class="tab-pane fade" id="properties">
                <div id="properties-list" class="row">
                    <!-- Properties will be loaded here -->
                </div>
            </div>
            <!-- Applications Tab -->
            <div class="tab-pane fade" id="applications">
                <div id="applications-list">
                    <!-- Applications will be loaded here -->
                </div>
            </div>
            <!-- Scores Tab -->
            <div class="tab-pane fade show active" id="scores">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">TenantScore Balınız</h5>
                                <div id="tenant-score-container">
                                    <canvas id="tenant-score-gauge"></canvas>
                                    <div id="tenant-score-value" class="text-center mt-3"></div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        90-100: Çox etibarlı icarədar<br>
                                        75-89: Yaxşı icarədar<br>
                                        50-74: Orta riskli icarədar<br>
                                        0-49: Yüksək riskli icarədar
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Kredit Skorunuz</h5>
                                <div id="credit-score-container" class="text-center">
                                    <canvas id="credit-score-gauge" width="200" height="200"></canvas>
                                    <div id="credit-score-message" class="mt-3">
                                        <a href="{{ url_for('questionnaire.questionnaire') }}" class="btn btn-primary">
                                            Kredit skorunuzu hesablamaq üçün müraciət edin və daha yaxşı şərtlərlə mənzil kirayəyə götürün
                                        </a>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        850-1000: Əla kredit skoru<br>
                                        700-849: Yaxşı kredit skoru<br>
                                        600-699: Orta kredit skoru<br>
                                        0-599: Riskli kredit skoru
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Received Ratings Tab -->
            <div class="tab-pane fade" id="received-ratings">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Ümumi Reytinqiniz</h5>
                                <div id="tenant-rating-container" class="my-4">
                                    <div class="text-center mb-4">
                                        <h2 class="display-4" id="average-rating">-</h2>
                                        <p class="text-muted">Ortalama reytinq (5 üzərindən)</p>
                                    </div>
                                    <div class="rating-dimensions">
                                        <div class="mb-3">
                                            <label>Ödəniş intizamı</label>
                                            <div class="progress">
                                                <div id="reliability-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-end d-block" id="reliability-score">-</small>
                                        </div>
                                        <div class="mb-3">
                                            <label>Əmlaka münasibət</label>
                                            <div class="progress">
                                                <div id="responsibility-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-end d-block" id="responsibility-score">-</small>
                                        </div>
                                        <div class="mb-3">
                                            <label>Ünsiyyət</label>
                                            <div class="progress">
                                                <div id="communication-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-end d-block" id="communication-score">-</small>
                                        </div>
                                        <div class="mb-3">
                                            <label>Qonşularla münasibət</label>
                                            <div class="progress">
                                                <div id="respect-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-end d-block" id="respect-score">-</small>
                                        </div>
                                        <div class="mb-3">
                                            <label>Müqavilə şərtlərinə uyğunluq</label>
                                            <div class="progress">
                                                <div id="compliance-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-end d-block" id="compliance-score">-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Aldığınız Qiymətləndirmələr</h5>
                                <div id="ratings-list">Yüklənir...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Given Ratings Tab -->
            <div class="tab-pane fade" id="given-ratings">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Verdiyiniz Qiymətləndirmələr</h5>
                        <div id="given-ratings">Yüklənir...</div>
                    </div>
                </div>
            </div>

            <!-- Rate Landlord Tab -->
            <div class="tab-pane fade" id="rate-landlord">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">İcarəyə verəni qiymətləndir</h5>
                        <form id="rate-landlord-form" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <div class="mb-3">
                                <label for="landlord-id" class="form-label">Mülk Sahibi</label>
                                <select class="form-control" id="landlord-id" required>
                                    <option value="">Mülk sahibi seçin</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="property-id" class="form-label">Əmlak</label>
                                <select class="form-control" id="property-id" required>
                                    <option value="">Əvvəlcə mülk sahibini seçin</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Əmlakın real vəziyyəti</label>
                                <select class="form-control" name="reliability" required>
                                    {% for i in range(5, 0, -1) %}
                                    <option value="{{ i }}">{{ i }} - {% if i == 5 %}Əla{% elif i == 4 %}Yaxşı{% elif i == 3 %}Orta{% elif i == 2 %}Zəif{% else %}Pis{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Müqavilə şəffaflığı</label>
                                <select class="form-control" name="responsibility" required>
                                    {% for i in range(5, 0, -1) %}
                                    <option value="{{ i }}">{{ i }} - {% if i == 5 %}Əla{% elif i == 4 %}Yaxşı{% elif i == 3 %}Orta{% elif i == 2 %}Zəif{% else %}Pis{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Ünsiyyət və dəstək</label>
                                <select class="form-control" name="communication" required>
                                    {% for i in range(5, 0, -1) %}
                                    <option value="{{ i }}">{{ i }} - {% if i == 5 %}Əla{% elif i == 4 %}Yaxşı{% elif i == 3 %}Orta{% elif i == 2 %}Zəif{% else %}Pis{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Təmir və texniki xidmət</label>
                                <select class="form-control" name="compliance" required>
                                    {% for i in range(5, 0, -1) %}
                                    <option value="{{ i }}">{{ i }} - {% if i == 5 %}Əla{% elif i == 4 %}Yaxşı{% elif i == 3 %}Orta{% elif i == 2 %}Zəif{% else %}Pis{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Gizlilik və hörmət</label>
                                <select class="form-control" name="respect" required>
                                    {% for i in range(5, 0, -1) %}
                                    <option value="{{ i }}">{{ i }} - {% if i == 5 %}Əla{% elif i == 4 %}Yaxşı{% elif i == 3 %}Orta{% elif i == 2 %}Zəif{% else %}Pis{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Rəy</label>
                                <textarea class="form-control" name="review" rows="3"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Qiymətləndir</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Function to get CSRF token from meta tag
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

// Initialize gauges when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load tenant score
    loadTenantScore();

    // Load credit score
    loadCreditScore();
    });

function getTenantScoreColor(score) {
    if (score >= 90) return 'success';
    if (score >= 75) return 'info';
    if (score >= 50) return 'warning';
    return 'danger';
}

function getTenantScoreText(score) {
    if (score >= 90) return 'Çox etibarlı icarədar';
    if (score >= 75) return 'Yaxşı icarədar';
    if (score >= 50) return 'Orta riskli icarədar';
    return 'Yüksək riskli icarədar';
}

function initTenantScoreGauge(score) {
    var opts = {
        angle: -0.2,
        lineWidth: 0.2,
        radiusScale: 0.9,
        pointer: {
            length: 0.6,
            strokeWidth: 0.035,
            color: '#000000'
        },
        limitMax: false,
        limitMin: false,
        colorStart: '#FF0000',
        colorStop: '#00FF00',
        strokeColor: '#E0E0E0',
        generateGradient: true,
        highDpiSupport: true,
        staticLabels: {
            font: "10px sans-serif",
            labels: [0, 25, 50, 75, 100],
            color: "#000000",
            fractionDigits: 0
        },
        staticZones: [
            {strokeStyle: "#FF0000", min: 0, max: 50},
            {strokeStyle: "#FFA500", min: 50, max: 75},
            {strokeStyle: "#FFFF00", min: 75, max: 90},
            {strokeStyle: "#00FF00", min: 90, max: 100}
        ],
    };
    
    var target = document.getElementById('tenant-score-gauge');
    var gauge = new Gauge(target).setOptions(opts);
    gauge.maxValue = 100;
    gauge.setMinValue(0);
    gauge.animationSpeed = 32;
    gauge.set(score);
}

// Format ratings display
function formatRatingStars(rating) {
    if (!rating) return '☆☆☆☆☆';
    return '★'.repeat(rating) + '☆'.repeat(5-rating);
}

// Fetch ratings
function loadRatings() {
    fetch(`/ratings/{{ current_user.id }}`)
        .then(response => response.json())
        .then(data => {
            if (!data.length) {
                document.getElementById('ratings-list').innerHTML = 'Hələ qiymətləndirmə yoxdur';
                document.getElementById('average-rating').textContent = '-';
                ['reliability', 'responsibility', 'communication', 'respect', 'compliance'].forEach(dim => {
                    document.getElementById(`${dim}-score`).textContent = '-';
                    document.getElementById(`${dim}-bar`).style.width = '0%';
                });
                return;
            }
            
            // Calculate averages for each dimension
            const dimensions = ['reliability', 'responsibility', 'communication', 'respect', 'compliance'];
            const averages = dimensions.reduce((acc, dim) => {
                acc[dim] = data.reduce((sum, r) => sum + r[dim], 0) / data.length;
                return acc;
            }, {});
            
            // Calculate overall average
            const overallAvg = Object.values(averages).reduce((a, b) => a + b) / 5;
            
            // Update the display
            document.getElementById('average-rating').textContent = overallAvg.toFixed(1);
            
            // Update each dimension's display
            dimensions.forEach(dim => {
                const score = averages[dim];
                const percentage = (score / 5) * 100;
                const bar = document.getElementById(`${dim}-bar`);
                const scoreElement = document.getElementById(`${dim}-score`);
                
                bar.style.width = `${percentage}%`;
                bar.className = `progress-bar bg-${getRatingColor(score)}`;
                scoreElement.textContent = score.toFixed(1);
            });
            
            const ratingsHtml = data.map(rating => `
                <div class="rating-item mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Mülk sahibi: ${rating.rater.name}</strong>
                        <small>Tarix: ${new Date(rating.created_at).toLocaleDateString('az-AZ')}</small>
                    </div>
                    <div class="rating-details">
                        <div>Ödəniş intizamı: ${formatRatingStars(rating.reliability)}</div>
                        <div>Əmlaka münasibət: ${formatRatingStars(rating.responsibility)}</div>
                        <div>Ünsiyyət: ${formatRatingStars(rating.communication)}</div>
                        <div>Qonşularla münasibət: ${formatRatingStars(rating.respect)}</div>
                        <div>Müqavilə şərtlərinə uyğunluq: ${formatRatingStars(rating.compliance)}</div>
                    </div>
                    ${rating.review ? `<div class="mt-2"><strong>Rəy:</strong> ${rating.review}</div>` : ''}
                    ${rating.property ? `
                        <div class="mt-2 text-muted">
                            <small>Əmlak: ${rating.property.title} - ${rating.property.address}</small>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            document.getElementById('ratings-list').innerHTML = ratingsHtml;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('ratings-list').innerHTML = 'Qiymətləndirmələri yükləmək mümkün olmadı';
            document.getElementById('average-rating').textContent = '-';
            ['reliability', 'responsibility', 'communication', 'respect', 'compliance'].forEach(dim => {
                document.getElementById(`${dim}-score`).textContent = '-';
                document.getElementById(`${dim}-bar`).style.width = '0%';
            });
        });
}

// Fetch landlords list when page loads
fetch('/api/landlords')
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(landlords => {
        const select = document.getElementById('landlord-id');
        landlords.forEach(landlord => {
            const option = document.createElement('option');
            option.value = landlord.id;
            option.textContent = `${landlord.name} (${landlord.email})`;
            select.appendChild(option);
        });
    })
    .catch(error => {
        console.error('Error fetching landlords:', error);
        alert('Mülk sahiblərinin siyahısını yükləmək mümkün olmadı');
    });

// Load properties when landlord is selected
document.getElementById('landlord-id').addEventListener('change', function() {
    const landlordId = this.value;
    if (!landlordId) {
        document.getElementById('property-id').innerHTML = '<option value="">Əvvəlcə mülk sahibini seçin</option>';
        return;
    }
    
    fetch(`/api/properties?landlord_id=${landlordId}`)
        .then(response => response.json())
        .then(properties => {
            const select = document.getElementById('property-id');
            select.innerHTML = '<option value="">Əmlak seçin</option>' +
                properties.map(property => 
                    `<option value="${property.id}">${property.title} - ${property.address}</option>`
                ).join('');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Əmlakları yükləmək mümkün olmadı');
        });
});

async function loadGivenRatings() {
    try {
        const response = await fetch(`/ratings/given/${currentUserId}`);
        const ratings = await response.json();
        const givenRatingsDiv = document.getElementById('given-ratings');
        
            if (!ratings.length) {
            givenRatingsDiv.innerHTML = '<div class="alert alert-info">Hələ heç bir qiymətləndirmə verməmisiniz</div>';
                return;
            }
            
            const ratingsHtml = ratings.map(rating => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="card-title mb-1">Mülk sahibi: ${rating.ratee.name}</h5>
                            ${rating.property ? 
                                `<h6 class="card-subtitle text-muted">Əmlak: ${rating.property.title}</h6>` 
                                : ''}
                        </div>
                        <span class="badge bg-${getRatingColor(calculateAverageRating(rating))} fs-5">
                            ${calculateAverageRating(rating).toFixed(1)} ★
                        </span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Əmlakın real vəziyyəti:</strong> ${formatRatingStars(rating.reliability)}</p>
                            <p><strong>Müqavilə şəffaflığı:</strong> ${formatRatingStars(rating.responsibility)}</p>
                            <p><strong>Ünsiyyət və dəstək:</strong> ${formatRatingStars(rating.communication)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Təmir və texniki xidmət:</strong> ${formatRatingStars(rating.compliance)}</p>
                            <p><strong>Gizlilik və hörmət:</strong> ${formatRatingStars(rating.respect)}</p>
                        </div>
                    </div>
                    
                    ${rating.review ? `
                        <div class="mt-3">
                            <strong>Rəy:</strong>
                            <p class="fst-italic">"${rating.review}"</p>
                        </div>
                    ` : ''}
                    
                    <div class="text-muted mt-2">
                        <small>Tarix: ${new Date(rating.created_at).toLocaleDateString('az-AZ')}</small>
                    </div>
                </div>
                </div>
            `).join('');
            
        givenRatingsDiv.innerHTML = ratingsHtml;
    } catch (error) {
            console.error('Error:', error);
        document.getElementById('given-ratings').innerHTML = 
            '<div class="alert alert-danger">Qiymətləndirmələri yükləmək mümkün olmadı</div>';
    }
}

function calculateAverageRating(rating) {
    const scores = [
        rating.reliability,
        rating.responsibility,
        rating.communication,
        rating.compliance,
        rating.respect
    ].filter(score => score !== null);
    
    return scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
}

// Form submission handler
document.getElementById('rate-landlord-form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        landlord_id: document.getElementById('landlord-id').value,
        property_id: document.getElementById('property-id').value,
        reliability: parseInt(formData.get('reliability')),
        responsibility: parseInt(formData.get('responsibility')),
        communication: parseInt(formData.get('communication')),
        respect: parseInt(formData.get('respect')),
        compliance: parseInt(formData.get('compliance')),
        review: formData.get('review')
    };
 
    fetch('/rate-landlord', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Qiymətləndirmə zamanı xəta baş verdi');
        }
        return response.json();
    })
    .then(data => {
        alert('Qiymətləndirmə uğurla əlavə edildi!');
        event.target.reset();
        loadGivenRatings();
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message);
    });
});

function getRatingColor(rating) {
    if (rating >= 4.5) return 'success';
    if (rating >= 3.5) return 'info';
    if (rating >= 2.5) return 'warning';
    return 'danger';
}

// Credit Score functions and fetch (questionnaire-based score)
function initCreditScoreGauge(score) {
    var opts = {
        angle: -0.2,
        lineWidth: 0.2,
        radiusScale: 0.9,
        pointer: {
            length: 0.6,
            strokeWidth: 0.035,
            color: '#000000'
        },
        limitMax: false,
        limitMin: false,
        colorStart: '#FF0000',
        colorStop: '#00FF00',
        strokeColor: '#E0E0E0',
        generateGradient: true,
        highDpiSupport: true,
        staticLabels: {
            font: "10px sans-serif",
            labels: [0, 200, 400, 600, 800, 1000],
            color: "#000000",
            fractionDigits: 0
        },
        staticZones: [
            {strokeStyle: "#FF0000", min: 0, max: 600},
            {strokeStyle: "#FFA500", min: 600, max: 700},
            {strokeStyle: "#FFFF00", min: 700, max: 850},
            {strokeStyle: "#00FF00", min: 850, max: 1000}
        ],
    };
    
    var target = document.getElementById('credit-score-gauge');
    var gauge = new Gauge(target).setOptions(opts);
    gauge.maxValue = 1000;
    gauge.setMinValue(0);
    gauge.animationSpeed = 32;
    gauge.set(score);
}

function getScoreColor(score) {
    if (score >= 850) return 'success';
    if (score >= 700) return 'info';
    if (score >= 600) return 'warning';
    return 'danger';
}

function getScoreText(score) {
    if (score >= 850) return 'Əla kredit skoru';
    if (score >= 700) return 'Yaxşı kredit skoru';
    if (score >= 600) return 'Orta kredit skoru';
    return 'Riskli kredit skoru';
}

// Load properties function
async function loadProperties() {
    try {
        const response = await fetch('/api/properties');
        const properties = await response.json();
        const propertiesList = document.getElementById('properties-list');
        
        if (!properties.length) {
            propertiesList.innerHTML = '<div class="col-12"><div class="alert alert-info">Hal-hazırda mövcud əmlak yoxdur</div></div>';
            return;
        }
        
        propertiesList.innerHTML = properties.map(property => `
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">${property.title}</h5>
                        <p class="card-text">${property.description || 'Təsvir yoxdur'}</p>
                        <ul class="list-unstyled">
                            <li><strong>Qiymət:</strong> ${property.monthly_rent} AZN/ay</li>
                            <li><strong>Ünvan:</strong> ${property.address}</li>
                            <li><strong>Mövcudluq tarixi:</strong> ${new Date(property.available_from).toLocaleDateString('az-AZ')}</li>
                        </ul>
                    </div>
                    <div class="card-footer">
                        <button onclick="applyForProperty('${property.id}')" class="btn btn-primary">Müraciət et</button>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('properties-list').innerHTML = 
            '<div class="col-12"><div class="alert alert-danger">Əmlakları yükləmək mümkün olmadı</div></div>';
    }
}

// Apply for property function
async function applyForProperty(propertyId) {
    try {
        const response = await fetch(`/apply/${propertyId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.next_step === 'tenant_info') {
            window.location.href = `/applications/${data.application_id}/tenant-info`;
        } else {
            alert('Müraciətiniz uğurla qeydə alındı!');
            loadProperties();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Müraciət zamanı xəta baş verdi');
    }
}

// Load applications function
async function loadApplications() {
    try {
        const response = await fetch('/api/applications/tenant');
        if (!response.ok) throw new Error('Server error');
        
        const applications = await response.json();
        const applicationsList = document.getElementById('applications-list');
        
        if (!applications.length) {
            applicationsList.innerHTML = '<div class="alert alert-info">Hal-hazırda aktiv müraciətiniz yoxdur</div>';
            return;
        }
        
        applicationsList.innerHTML = applications.map(app => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title">${app.property.title}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">Mülk sahibi: ${app.property.landlord.name}</h6>
                        </div>
                        <span class="badge bg-${getStatusColor(app.status)}">
                            ${app.status === 'pending' ? 'Təsdiq gözləyir' : getStatusText(app.status)}
                        </span>
                    </div>
                    <p class="card-text">
                        <strong>Ünvan:</strong> ${app.property.address}<br>
                        <strong>Aylıq kirayə:</strong> ${app.property.monthly_rent} AZN<br>
                        <strong>Müraciət tarixi:</strong> ${new Date(app.created_at).toLocaleDateString('az-AZ')}
                    </p>
                    <hr>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <strong class="me-2">Müqavilə statusu:</strong>
                                <span class="badge bg-${getContractStatusColor(app.contract_status)}">
                                    ${app.contract_status === 'none' ? 'Şəxsi məlumatlar tələb olunur' : getContractStatusText(app.contract_status)}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            ${app.contract_status === 'none' ? `
                                <a href="/applications/${app.id}/tenant-info" class="btn btn-warning btn-sm">
                                    <i class="fas fa-user-edit"></i> Şəxsi məlumatları daxil et
                                </a>
                            ` : app.contract_status === 'completed' ? `
                                <a href="/applications/${app.id}/contract/download" class="btn btn-success btn-sm">
                                    <i class="fas fa-download"></i> Müqaviləni yüklə
                                </a>
                            ` : app.status === 'approved' || app.status === 'pending_contract' ? `
                                <a href="/applications/${app.id}/contract" class="btn btn-primary btn-sm">
                                    <i class="fas fa-file-signature"></i> Müqaviləyə bax
                                </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('applications-list').innerHTML = 
            '<div class="alert alert-danger">Müraciətləri yükləmək mümkün olmadı</div>';
    }
}

function getStatusColor(status) {
    const colors = {
        'pending': 'warning',
        'approved': 'success',
        'rejected': 'danger',
        'pending_contract': 'info',
        'completed': 'success',
        'cancelled': 'secondary'
    };
    return colors[status] || 'secondary';
}

function getStatusText(status) {
    const texts = {
        'pending': 'Gözləmədə',
        'approved': 'Təsdiqlənib',
        'rejected': 'Rədd edilib',
        'pending_contract': 'Müqavilə gözləyir',
        'completed': 'Tamamlanıb',
        'cancelled': 'Ləğv edilib'
    };
    return texts[status] || status;
}

// Update tab change event listener to refresh content
document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('show.bs.tab', event => {
        const target = event.target.getAttribute('href');
        if (target === '#properties') {
            loadProperties();
        } else if (target === '#applications') {
            loadApplications();
        } else if (target === '#received-ratings') {
            loadRatings();
        } else if (target === '#given-ratings') {
            loadGivenRatings();
        } else if (target === '#rate-landlord') {
            loadGivenRatings();
        }
    });
});

// Initial load of all data
loadProperties();
loadApplications();
loadRatings();
loadGivenRatings();

function getContractStatusColor(status) {
    const colors = {
        'draft': 'info',
        'pending_signatures': 'warning',
        'completed': 'success',
        'none': 'secondary',
        null: 'secondary',
        undefined: 'secondary'
    };
    return colors[status] || 'secondary';
}

function getContractStatusText(status) {
    const texts = {
        'draft': 'Qaralama',
        'pending_signatures': 'İmza gözləyir',
        'completed': 'Tamamlanıb',
        'none': 'Müqavilə yoxdur',
        null: 'Müqavilə yoxdur',
        undefined: 'Müqavilə yoxdur'
    };
    return texts[status] || status || 'Müqavilə yoxdur';
}

function getTenantScoreLabel(score) {
    if (score >= 90) return 'Əla';
    if (score >= 80) return 'Çox yaxşı';
    if (score >= 70) return 'Yaxşı';
    if (score >= 60) return 'Orta';
    if (score >= 50) return 'Qənaətbəxş';
    return 'Zəif';
}

function getCreditScoreLabel(score) {
    if (score >= 90) return 'Əla kredit reytinqi';
    if (score >= 80) return 'Yaxşı kredit reytinqi';
    if (score >= 70) return 'Orta kredit reytinqi';
    if (score >= 60) return 'Qənaətbəxş kredit reytinqi';
    if (score >= 50) return 'Aşağı kredit reytinqi';
    return 'Zəif kredit reytinqi';
}

// Update the tenant score display function
async function loadTenantScore() {
    try {
        const response = await fetch(`/tenant-score/${currentUserId}`);
        if (!response.ok) throw new Error('Server error');
        
        const data = await response.json();
        
        // Initialize gauge with the score
        if (data.total_score !== undefined) {
            initTenantScoreGauge(data.total_score);
            const scoreLabel = getTenantScoreLabel(data.total_score);
            document.getElementById('tenant-score-value').innerHTML = `
                <h4>${data.total_score}</h4>
                <p class="text-muted">${scoreLabel}</p>
            `;
        } else {
            document.getElementById('tenant-score-container').innerHTML = `
                <div class="alert alert-warning">
                    <h4>Qiymətləndirmə yoxdur</h4>
                    <p>Hələ ki qiymətləndirmə edilməyib</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading tenant score:', error);
        document.getElementById('tenant-score-container').innerHTML = `
            <div class="alert alert-danger">
                <h4>Xəta baş verdi</h4>
                <p>Kirayəçi balını yükləmək mümkün olmadı</p>
            </div>
        `;
    }
}

// Update the credit score display function
async function loadCreditScore() {
    try {
        const response = await fetch(`/api/tenant-score/${currentUserId}`);
        if (!response.ok) throw new Error('Server error');
        
        const data = await response.json();
        
        if (data.credit_score !== undefined) {
            initCreditScoreGauge(data.credit_score);
            const scoreLabel = getCreditScoreLabel(data.credit_score);
            document.getElementById('credit-score-message').innerHTML = `
                <h4>${data.credit_score}</h4>
                <p class="text-muted">${scoreLabel}</p>
            `;
        } else {
            document.getElementById('credit-score-container').innerHTML = `
                <div class="alert alert-warning">
                    <h4>Kredit skoru yoxdur</h4>
                    <p>Kredit məlumatları mövcud deyil</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading credit score:', error);
        document.getElementById('credit-score-message').innerHTML = `
            <a href="{{ url_for('questionnaire.questionnaire') }}" class="btn btn-primary">
                Kredit skorunuzu hesablamaq üçün müraciət edin və daha yaxşı şərtlərlə mənzil kirayəyə götürün
            </a>
        `;
    }
}
</script>
{% endblock %} 